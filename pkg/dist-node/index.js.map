{"version":3,"file":"index.js","sources":["../dist-src/index.js"],"sourcesContent":["/**\n * Copyright Â© 2019 kevinpollet <pollet.kevin@gmail.com>`\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE.md file.\n */\nimport fs from \"fs-extra\";\nimport { join } from \"path\";\nimport { exec } from \"pkg\";\nimport { MessageError } from \"@pika/types\";\nexport const beforeJob = async ({ manifest, options, out, }) => {\n    const packageJSONPath = join(out, \"package.json\");\n    const distNodeFolderPath = join(out, \"dist-node\");\n    const simpleBinEntrypointPath = join(distNodeFolderPath, \"index.bin.js\");\n    const mainEntrypointPath = join(distNodeFolderPath, manifest.main || \"index.js\");\n    const distNodeFolderPathExists = await fs.pathExists(distNodeFolderPath);\n    if (!distNodeFolderPathExists) {\n        throw new MessageError(`\"${distNodeFolderPath}\" does not exist, or was not yet created in the pipeline.`);\n    }\n    const mainEntrypointPathExists = await fs.pathExists(mainEntrypointPath);\n    if (!mainEntrypointPathExists) {\n        throw new MessageError(`\"${mainEntrypointPath}\" is the expected node entrypoint, but it does not exist.`);\n    }\n    const simpleBinEntrypointPathExists = await fs.pathExists(simpleBinEntrypointPath);\n    const binEntrypointPath = simpleBinEntrypointPathExists\n        ? simpleBinEntrypointPath\n        : manifest.bin;\n    return fs.writeJSON(packageJSONPath, {\n        name: options.name || manifest.name,\n        bin: binEntrypointPath,\n        main: mainEntrypointPath,\n        pkg: {\n            assets: options.assets || [],\n            scripts: options.scripts || [],\n        },\n    });\n};\nexport const build = ({ options, out, reporter, }) => {\n    const { debug, targets } = options;\n    const outPath = join(out, options.outPath || \"bin\");\n    const args = [out, \"--out-path\", outPath];\n    if (debug) {\n        args.push(\"--debug\");\n    }\n    if (targets) {\n        args.push(\"--targets\", targets.join(\",\"));\n    }\n    return exec(args)\n        .then(() => fs.readdir(outPath))\n        .then((generatedFiles) => generatedFiles.forEach((generatedFile) => reporter.created(join(outPath, generatedFile))));\n};\nexport const afterJob = ({ out }) => {\n    const packageJSONPath = join(out, \"package.json\");\n    return fs.remove(packageJSONPath);\n};\n"],"names":["beforeJob","manifest","options","out","packageJSONPath","join","distNodeFolderPath","simpleBinEntrypointPath","mainEntrypointPath","main","distNodeFolderPathExists","fs","pathExists","MessageError","mainEntrypointPathExists","simpleBinEntrypointPathExists","binEntrypointPath","bin","writeJSON","name","pkg","assets","scripts","build","reporter","debug","targets","outPath","args","push","exec","then","readdir","generatedFiles","forEach","generatedFile","created","afterJob","remove"],"mappings":";;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;MAKaA,SAAS,GAAG,OAAO;AAAEC,EAAAA,QAAF;AAAYC,EAAAA,OAAZ;AAAqBC,EAAAA;AAArB,CAAP,KAAuC;AAC5D,QAAMC,eAAe,GAAGC,SAAI,CAACF,GAAD,EAAM,cAAN,CAA5B;AACA,QAAMG,kBAAkB,GAAGD,SAAI,CAACF,GAAD,EAAM,WAAN,CAA/B;AACA,QAAMI,uBAAuB,GAAGF,SAAI,CAACC,kBAAD,EAAqB,cAArB,CAApC;AACA,QAAME,kBAAkB,GAAGH,SAAI,CAACC,kBAAD,EAAqBL,QAAQ,CAACQ,IAAT,IAAiB,UAAtC,CAA/B;AACA,QAAMC,wBAAwB,GAAG,MAAMC,EAAE,CAACC,UAAH,CAAcN,kBAAd,CAAvC;;AACA,MAAI,CAACI,wBAAL,EAA+B;AAC3B,UAAM,IAAIG,kBAAJ,CAAkB,IAAGP,kBAAmB,2DAAxC,CAAN;AACH;;AACD,QAAMQ,wBAAwB,GAAG,MAAMH,EAAE,CAACC,UAAH,CAAcJ,kBAAd,CAAvC;;AACA,MAAI,CAACM,wBAAL,EAA+B;AAC3B,UAAM,IAAID,kBAAJ,CAAkB,IAAGL,kBAAmB,2DAAxC,CAAN;AACH;;AACD,QAAMO,6BAA6B,GAAG,MAAMJ,EAAE,CAACC,UAAH,CAAcL,uBAAd,CAA5C;AACA,QAAMS,iBAAiB,GAAGD,6BAA6B,GACjDR,uBADiD,GAEjDN,QAAQ,CAACgB,GAFf;AAGA,SAAON,EAAE,CAACO,SAAH,CAAad,eAAb,EAA8B;AACjCe,IAAAA,IAAI,EAAEjB,OAAO,CAACiB,IAAR,IAAgBlB,QAAQ,CAACkB,IADE;AAEjCF,IAAAA,GAAG,EAAED,iBAF4B;AAGjCP,IAAAA,IAAI,EAAED,kBAH2B;AAIjCY,IAAAA,GAAG,EAAE;AACDC,MAAAA,MAAM,EAAEnB,OAAO,CAACmB,MAAR,IAAkB,EADzB;AAEDC,MAAAA,OAAO,EAAEpB,OAAO,CAACoB,OAAR,IAAmB;AAF3B;AAJ4B,GAA9B,CAAP;AASH;MACYC,KAAK,GAAG,CAAC;AAAErB,EAAAA,OAAF;AAAWC,EAAAA,GAAX;AAAgBqB,EAAAA;AAAhB,CAAD,KAAiC;AAClD,QAAM;AAAEC,IAAAA,KAAF;AAASC,IAAAA;AAAT,MAAqBxB,OAA3B;AACA,QAAMyB,OAAO,GAAGtB,SAAI,CAACF,GAAD,EAAMD,OAAO,CAACyB,OAAR,IAAmB,KAAzB,CAApB;AACA,QAAMC,IAAI,GAAG,CAACzB,GAAD,EAAM,YAAN,EAAoBwB,OAApB,CAAb;;AACA,MAAIF,KAAJ,EAAW;AACPG,IAAAA,IAAI,CAACC,IAAL,CAAU,SAAV;AACH;;AACD,MAAIH,OAAJ,EAAa;AACTE,IAAAA,IAAI,CAACC,IAAL,CAAU,WAAV,EAAuBH,OAAO,CAACrB,IAAR,CAAa,GAAb,CAAvB;AACH;;AACD,SAAOyB,QAAI,CAACF,IAAD,CAAJ,CACFG,IADE,CACG,MAAMpB,EAAE,CAACqB,OAAH,CAAWL,OAAX,CADT,EAEFI,IAFE,CAEIE,cAAD,IAAoBA,cAAc,CAACC,OAAf,CAAwBC,aAAD,IAAmBX,QAAQ,CAACY,OAAT,CAAiB/B,SAAI,CAACsB,OAAD,EAAUQ,aAAV,CAArB,CAA1C,CAFvB,CAAP;AAGH;MACYE,QAAQ,GAAG,CAAC;AAAElC,EAAAA;AAAF,CAAD,KAAa;AACjC,QAAMC,eAAe,GAAGC,SAAI,CAACF,GAAD,EAAM,cAAN,CAA5B;AACA,SAAOQ,EAAE,CAAC2B,MAAH,CAAUlC,eAAV,CAAP;AACH;;;;;;"}